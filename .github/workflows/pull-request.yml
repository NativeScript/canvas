name: Canvas Native

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  NPM_TAG: "pr"
  EMULATOR_NAME: "runtime-emu"
  NDK_VERSION: r23c
  ANDROID_API: 29
  ANDROID_ABI: x86_64
  NDK_ARCH: linux
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    outputs:
      npm_version: ${{ steps.npm_version_output.outputs.NPM_VERSION }}
      npm_tag: ${{ steps.npm_version_output.outputs.NPM_TAG }}
    steps:
    - uses: actions/checkout@v3
    - name: Install rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    - name: 'Install Rust target i686-linux-android'
      shell: bash
      run: |
        rustup target add i686-linux-android
    - name: 'Install Rust target x86_64-linux-android'
      shell: bash
      run: |
        rustup target add x86_64-linux-android
    - name: 'Install Rust target armv7-linux-androideabi'
      shell: bash
      run: |
        rustup target add armv7-linux-androideabi
    - name: 'Install Rust target aarch64-linux-android'
      shell: bash
      run: |
        rustup target add aarch64-linux-android       
    - uses: actions/setup-node@v3
      with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"
    - uses: actions/setup-java@v3
      with:
          distribution: "temurin"
          java-version: "17"
          cache: gradle
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
    - name: Setup NDK
      run: |
          echo "y" | sdkmanager "cmake;3.6.4111459"
          wget https://dl.google.com/android/repository/android-ndk-$NDK_VERSION-$NDK_ARCH.zip
          chmod +x android-ndk-$NDK_VERSION-$NDK_ARCH.zip
          unzip -q android-ndk-$NDK_VERSION-$NDK_ARCH.zip
          rm -rf android-ndk-$NDK_VERSION-$NDK_ARCH.zip
          export ANDROID_NDK_HOME=`pwd`/android-ndk-$NDK_VERSION
          echo ANDROID_NDK_HOME=${ANDROID_NDK_HOME} >> $GITHUB_ENV
          echo ANDROID_NDK=${ANDROID_NDK_HOME} >> $GITHUB_ENV
          echo ${ANDROID_NDK_HOME} >> $GITHUB_PATH
    - name: Build Canvas Native
      run: |
          make android
    
